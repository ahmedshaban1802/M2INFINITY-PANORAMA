<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام الإدارة المتكامل (هوية الموظف)</title>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html2pdf Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- --- BARCODE GENERATOR LIBRARY (JsBarcode) --- -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- --- SheetJS for Excel Export --- -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            /* --- LIGHT MODE --- */
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --success: #2ec4b6;
            --danger: #ef476f;
            --warning: #ffd166;
            --info: #4cc9f0;
            --dark: #2b2d42;
            --light: #f8f9fa;
            --gray: #8d99ae;
            --bg-grad: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
            --radius: 16px;
            --card-bg: #ffffff;
            --text-color: #2b2d42;
            --input-bg: #fcfcfc;
            --border-color: #eee;
        }
        
        /* --- DARK MODE --- */
        body.dark-mode {
            --primary: #4cc9f0;
            --primary-dark: #4361ee;
            --success: #2ec4b6;
            --danger: #ef476f;
            --warning: #ffd166;
            --info: #4361ee;
            --dark: #e0e0e0;
            --light: #1a1a2e;
            --gray: #a0a0a0;
            --bg-grad: #121212;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            --card-bg: #1f1f38;
            --text-color: #e0e0e0;
            --input-bg: #2b2b40;
            --border-color: #3a3a55;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; outline: none; -webkit-tap-highlight-color: transparent; transition: background 0.3s, color 0.3s, border-color 0.3s; }
        
        body {
            background: var(--bg-grad);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* --- LOGIN SCREEN --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #4361ee);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .auth-card {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 50px 40px; border-radius: 30px; width: 90%; max-width: 420px; text-align: center;
            color: white; animation: fadeInUp 0.8s ease-out; position: relative; overflow: hidden;
        }
        .auth-card::before {
            content: ''; position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            width: 150px; height: 150px; background: var(--primary); filter: blur(60px); opacity: 0.5; z-index: -1;
        }
        .auth-icon { font-size: 50px; margin-bottom: 20px; color: var(--warning); animation: floatIcon 3s ease-in-out infinite; }
        @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .auth-title { font-size: 24px; font-weight: 800; margin-bottom: 30px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .auth-input { 
            width: 100%; padding: 15px 20px; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.2); border-radius: 12px; font-size: 16px; color: white; text-align: center; transition: 0.3s;
        }
        .auth-input::placeholder { color: rgba(255,255,255,0.6); }
        .auth-input:focus { border-color: var(--warning); background: rgba(0,0,0,0.4); box-shadow: 0 0 15px rgba(255, 209, 102, 0.2); }
        .auth-btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            background: linear-gradient(90deg, var(--primary), var(--info)); color: white; font-weight: 800; font-size: 18px;
            cursor: pointer; transition: 0.4s; margin-top: 10px; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4); letter-spacing: 1px;
        }
        .auth-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(67, 97, 238, 0.6); }
        .error-msg { color: #ff6b6b; font-size: 14px; margin-top: 20px; opacity: 0; transition: 0.3s; min-height: 20px; font-weight: 600; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 5px; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        .shake { animation: shake 0.5s; border: 1px solid var(--danger); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }

        /* --- MAIN APP --- */
        .container { max-width: 1600px; margin: 0 auto; transition: all 0.3s ease; display: none; }
        
        header {
            background: var(--card-bg); border-radius: var(--radius); padding: 20px 30px;
            box-shadow: var(--shadow); display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;
            border-bottom: 4px solid var(--primary);
        }
        .brand { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .brand-icon {
            width: 45px; height: 45px; background: var(--primary); color: white;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4); overflow: hidden;
        }
        .brand-icon img { width: 100%; height: 100%; object-fit: cover; }
        
        h2 { font-size: 20px; font-weight: 800; color: var(--text-color); white-space: nowrap; }
        
        .header-tools { display: flex; gap: 10px; align-items: flex-end; flex-direction: column; }

        .icon-btn {
            background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .icon-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        .logout-btn {
            background: rgba(239, 71, 111, 0.1); color: var(--danger); border: 1px solid rgba(239, 71, 111, 0.2);
            padding: 8px 15px; border-radius: 30px; font-size: 13px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.3s;
        }
        .logout-btn:hover { background: var(--danger); color: white; box-shadow: 0 4px 15px rgba(239, 71, 111, 0.3); }

        .live-clock {
            background: rgba(67, 97, 238, 0.1); color: var(--primary); padding: 8px 15px; border-radius: 20px;
            font-family: 'Courier New', monospace; font-weight: 700; font-size: 16px;
            border: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px;
            letter-spacing: 1px; flex-shrink: 0;
        }
        
        .user-info { font-size:13px; font-weight:700; color:var(--primary); display:flex; align-items:center; gap:5px;}

        /* --- TABS --- */
        .main-tabs {
            display: flex; background: var(--card-bg); padding: 5px; border-radius: 50px;
            box-shadow: var(--shadow); margin-bottom: 25px; width: fit-content; margin-right: auto; margin-left: auto;
        }
        .tab-btn {
            padding: 10px 30px; border-radius: 40px; border: none; background: transparent;
            color: var(--gray); font-weight: 700; font-size: 15px; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Stats & Panel */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card {
            background: var(--card-bg); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 15px;
            transition: transform 0.3s ease; border: 1px solid var(--border-color);
        }
        .stat-card:hover { transform: translateY(-5px); }
        .s-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .s-info h4 { font-size: 12px; color: var(--gray); margin-bottom: 2px; }
        .s-info span { font-size: 24px; font-weight: 800; color: var(--text-color); }
        .c-pres { background: rgba(46, 196, 182, 0.1); color: var(--success); }
        .c-abs { background: rgba(239, 71, 111, 0.1); color: var(--danger); }
        .c-lev { background: rgba(255, 209, 102, 0.1); color: #e0aa00; }
        .c-money { background: rgba(67, 97, 238, 0.1); color: var(--primary); }

        .panel { background: var(--card-bg); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 25px; border: 1px solid var(--border-color); }
        .input-group { position: relative; margin-bottom: 20px; }
        .input-group label { display: block; font-size: 13px; font-weight: 700; color: var(--gray); margin-bottom: 8px; }
        .input-group i { position: absolute; right: 15px; top: 40px; color: var(--gray); transition: 0.3s; pointer-events:none;}
        .inp { width: 100%; padding: 12px 45px 12px 15px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 15px; transition: 0.3s; background: var(--input-bg); color: var(--text-color); }
        .inp:read-only { background-color: rgba(0,0,0,0.05); cursor: not-allowed; }
        .inp:focus { border-color: var(--primary); background: var(--card-bg); box-shadow: 0 0 0 4px rgba(67,97,238,0.1); }
        .inp:focus + i { color: var(--primary); }

        /* Buttons Grid */
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .btn {
            padding: 14px; border: none; border-radius: 12px; color: white; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s; font-size: 14px; position: relative; overflow: hidden; white-space: nowrap;
        }
        .btn:active { transform: scale(0.98); }
        .b-in { background: linear-gradient(135deg, #2ec4b6 0%, #20a4a4 100%); box-shadow: 0 4px 15px rgba(46, 196, 182, 0.3); }
        .b-out { background: linear-gradient(135deg, #ef476f 0%, #d6335c 100%); box-shadow: 0 4px 15px rgba(239, 71, 111, 0.3); }
        .b-abs { background: linear-gradient(135deg, #ffd166 0%, #ffbd00 100%); color: #5d4000; box-shadow: 0 4px 15px rgba(255, 209, 102, 0.3); }
        .b-ded { background: linear-gradient(135deg, #7209b7 0%, #560bad 100%); box-shadow: 0 4px 15px rgba(114, 9, 183, 0.3); }
        .b-del { background: var(--input-bg); color: var(--danger); border: 2px solid var(--border-color); }
        .b-del:hover { background: rgba(239, 71, 111, 0.1); }
        .b-money { background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3); }
        .b-pdf { background: #e74c3c; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }

        /* Tools Area */
        .tools { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-color); 
            align-items: center; justify-content: space-between;
        }
        .tools-left { display: flex; gap: 10px; flex-wrap: wrap; flex: 1; }
        .tools-right { display: flex; gap: 10px; }

        .tool-btn {
            flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--card-bg);
            color: var(--text-color); cursor: pointer; transition: 0.3s; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 6px;
            min-width: 100px;
        }
        .tool-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(67, 97, 238, 0.05); }

        /* Table */
        .table-wrap { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); overflow-x: auto; position:relative; z-index:1; border: 1px solid var(--border-color);}
        .t-head {
            background: var(--input-bg); padding: 15px 25px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; min-width: 700px;
        }
        .view-date { font-weight: 800; color: var(--primary); font-size: 16px; }
        .nav-btns { display: flex; gap: 5px; }
        .nav-btn {
            width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg);
            color: var(--text-color); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .nav-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { padding: 12px; text-align: center; font-size: 13px; color: var(--gray); font-weight: 700; background: var(--input-bg); white-space: nowrap; }
        td { padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 14px; color: var(--text-color); white-space: nowrap; vertical-align: middle;}
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(67, 97, 238, 0.05); }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .bg-pres { background: rgba(46, 196, 182, 0.15); color: #16a096; }
        .bg-abs { background: rgba(239, 71, 111, 0.15); color: #d6335c; }
        .bg-lev { background: rgba(255, 209, 102, 0.15); color: #d4a000; }

        .action-btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--primary); cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; margin: 0 2px; }
        .action-btn:hover { background: var(--primary); color: white; }
        .action-btn.del:hover { background: var(--danger); border-color: var(--danger); color: white; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 100; align-items: center; justify-content: center; }
        .modal-content {
            background: var(--card-bg); width: 95%; max-width: 1000px; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height:95vh; overflow-y:auto;
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .m-head { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .m-title { font-size: 18px; font-weight: 800; color: var(--text-color); }
        .m-close { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--border-color); cursor: pointer; color: var(--text-color); transition: 0.2s; }
        .m-close:hover { background: var(--danger); color: white; }
        
        /* USER CREATION SPLIT LAYOUT */
        .user-creation-layout {
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;
        }
        @media(max-width: 800px) { .user-creation-layout { grid-template-columns: 1fr; } }

        .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full { grid-column: span 2; }
        textarea.inp { resize: none; height: 80px; }

        /* --- ID CARD STYLES (Preview & Print) --- */
        .id-card-wrapper {
            background: #fff;
            width: 350px;
            height: 550px;
            border-radius: 20px;
            border: 1px solid #ddd;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            margin: 0 auto;
        }
        
        .id-card-header {
            background: var(--primary);
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .id-card-header h2 { font-size: 18px; margin:0; white-space: nowrap; }

        .id-card-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: -60px;
            background: #eee;
            overflow: hidden;
            z-index: 2;
        }
        .id-card-photo img { width: 100%; height: 100%; object-fit: cover; }

        .id-card-info { margin-top: 15px; width: 100%; padding: 0 20px; }
        .id-card-name { font-size: 22px; font-weight: 800; color: var(--dark); margin-bottom: 5px; }
        .id-card-role { font-size: 14px; color: var(--gray); font-weight: 600; background: var(--input-bg); padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 20px; }
        
        .id-card-footer {
            background: #f9f9f9;
            width: 100%;
            margin-top: auto;
            padding: 20px 10px;
            border-top: 1px dashed #ddd;
        }
        .id-card-barcode { margin-bottom: 10px; }
        
        /* --- HANDHELD SCANNER INPUT --- */
        .scan-input-wrapper { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .scan-input-field {
            width: 100%; font-size: 20px; padding: 15px;
            border: 2px solid var(--primary); border-radius: 10px;
            text-align: center; font-weight: bold; letter-spacing: 2px;
            background: var(--input-bg); color: var(--text-color);
            font-family: monospace;
        }
        .scan-input-field:focus { border-color: var(--success); box-shadow: 0 0 15px rgba(46, 196, 182, 0.3); }

        /* Toast */
        .toast {
            position: fixed; top: 20px; left: 20px; background: var(--card-bg); padding: 15px 25px;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 10px; transform: translateX(-150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 200;
            border-right: 5px solid;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .toast i { font-size: 18px; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }

        /* Footer */
        footer {
            text-align: center; margin-top: 40px; padding: 25px;
            background: var(--card-bg); border-radius: var(--radius);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            border-top: 4px solid var(--primary);
        }
        .dev-signature {
            font-size: 18px; font-weight: 800; color: var(--primary);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* Users List */
        .users-list { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .user-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: var(--input-bg); border-radius: 8px; margin-bottom: 8px;
        }
        .user-role-badge {
            font-size: 11px; padding: 2px 8px; border-radius: 4px; background: #eee; color: #555;
        }
        .user-pin-box {
            background: var(--primary); color: white; padding: 2px 8px;
            border-radius: 6px; font-family: monospace; font-weight: bold; letter-spacing: 2px;
            font-size: 14px; display: flex; align-items: center; gap: 5px;
        }

        /* Activity Log (Timeline) */
        .activity-timeline { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .log-item {
            position: relative; padding-right: 30px; margin-bottom: 20px; border-right: 2px solid var(--border-color);
        }
        .log-item::before {
            content: ''; position: absolute; right: -6px; top: 0; width: 10px; height: 10px;
            border-radius: 50%; background: var(--primary); border: 2px solid var(--card-bg);
        }
        .log-time { font-size: 11px; color: var(--gray); margin-bottom: 4px; }
        .log-text { font-size: 14px; font-weight: 600; }
        .log-detail { font-size: 13px; color: var(--text-color); opacity: 0.8; margin-top: 4px; }

        /* --- PRINT STYLES --- */
        @media print {
            body { background: white; color: black; padding: 0; }
            #auth-screen, header, .main-tabs, .panel, .tools, .tools, .stats, footer, .action-btn, .nav-btns, .no-print, .m-head, .m-close, .modal-body:not(#print-area) { display: none !important; }
            .container { display: block !important; max-width: 100%; margin: 0; box-shadow: none; }
            .table-wrap { box-shadow: none; border: 1px solid #000; }
            .tab-content { display: block !important; }
            table { width: 100%; min-width: auto; font-size: 12px; }
            th, td { border: 1px solid #ddd; color: black; }
            .t-head { display: none; }
            thead { display: table-header-group; }
            
            /* ID CARD PRINT STYLES */
            .modal { position: relative; background: white; border: none; box-shadow: none; padding: 0; overflow: visible; }
            .modal-content { max-width: none; width: 100%; padding: 0; box-shadow: none; animation: none; }
            
            body.printing-mode .user-creation-layout { display: block; }
            body.printing-mode .edit-grid, body.printing-mode .btn-money { display: none; }
            
            /* Position the ID card specifically */
            .id-card-wrapper {
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                border: 2px solid #000; -webkit-print-color-adjust: exact;
            }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { width: 100%; max-width: 100%; padding: 0; }
            header { flex-wrap: nowrap; overflow-x: auto; padding: 15px; gap: 15px; border-bottom: none; margin-bottom: 15px; }
            .brand { flex-direction: column; align-items: flex-start; justify-content: center; min-width: 100px; }
            h2 { font-size: 16px; }
            .header-tools { flex-direction: row; align-items: center; }
            .logout-btn span { display: none; }
            .logout-btn { padding: 8px 12px; }
        }
    </style>
</head>
<body>

    <!-- LOGIN OVERLAY -->
    <div id="auth-screen">
        <div class="auth-card" id="loginCard">
            <div class="auth-icon"><i class="fas fa-shield-alt"></i></div>
            <h2 class="auth-title">بوابة الدخول الآمنة</h2>
            
            <input type="text" id="authUser" class="auth-input" placeholder="اسم المستخدم" autocomplete="off">
            <input type="password" id="authPass" class="auth-input" placeholder="كلمة المرور" autocomplete="new-password">
            
            <button class="auth-btn" onclick="attemptLogin()">
                دخول النظام <i class="fas fa-arrow-left" style="margin-right:5px;"></i>
            </button>
            
            <div class="error-msg" id="loginError">بيانات الدخول غير صحيحة!</div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="container">
        <header>
            <div class="brand">
                <div class="brand-icon" id="headerLogo"><i class="fas fa-building"></i></div>
                <div>
                    <h2 id="companyNameDisplay">نظام الإدارة المتكامل (هوية الموظف)</h2>
                    <div style="font-size:11px; color:var(--gray);">حضور وانصراف | مرتبات | تحكم كامل</div>
                </div>
            </div>
            <div class="header-tools">
                <div style="display:flex; gap:8px; align-items:center;">
                    <!-- SYSTEM SETTINGS (Admin Only) -->
                    <button id="sysSettingsBtn" class="icon-btn" onclick="openSystemSettings()" title="إعدادات النظام"><i class="fas fa-cogs"></i></button>
                    
                    <!-- USER MANAGEMENT (Admin Only) -->
                    <button id="adminUsersBtn" class="icon-btn" onclick="openUsersModal()" title="إدارة المستخدمين"><i class="fas fa-users-cog"></i></button>

                    <!-- ACTIVITY LOG (Admin Only) -->
                    <button id="activityLogBtn" class="icon-btn" onclick="openActivityLog()" title="سجل النشاطات"><i class="fas fa-history"></i></button>
                    
                    <!-- CHANGE PASSWORD -->
                    <button class="icon-btn" onclick="openChangePassModal()" title="تغيير كلمة المرور"><i class="fas fa-key"></i></button>
                    
                    <!-- DARK MODE -->
                    <button class="icon-btn" onclick="toggleTheme()" title="الوضع الليلي"><i id="themeIcon" class="fas fa-moon"></i></button>

                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>خروج</span>
                    </button>
                </div>
                
                <div class="live-clock">
                    <i class="far fa-clock"></i>
                    <span id="clockDisplay">--:--:--</span>
                </div>
                <div class="user-info" id="userInfoDisplay"></div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="main-tabs">
            <button class="tab-btn active" onclick="switchTab('attendance')">
                <i class="fas fa-calendar-check"></i> الحضور والانصراف
            </button>
            <button id="salariesTabBtn" class="tab-btn" onclick="switchTab('salaries')">
                <i class="fas fa-money-bill-wave"></i> إدارة المرتبات
            </button>
        </div>
        
        <!-- TAB 1: ATTENDANCE -->
        <div id="attendance" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="s-icon c-pres"><i class="fas fa-user-check"></i></div>
                    <div class="s-info"><h4>الحضور</h4><span id="presentCount">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="s-icon c-abs"><i class="fas fa-user-times"></i></div>
                    <div class="s-info"><h4>الغياب</h4><span id="absentCount">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="s-icon c-lev"><i class="fas fa-sign-out-alt"></i></div>
                    <div class="s-info"><h4>الانصراف</h4><span id="leaveCount">0</span></div>
                </div>
            </div>
            
            <div class="panel">
                <div class="input-group">
                    <label>اسم الموظف (يدوياً)</label>
                    <input type="text" id="employeeName" class="inp" placeholder="أدخل الاسم هنا...">
                    <i class="fas fa-user"></i>
                </div>

                <!-- --- HANDHELD SCANNER BUTTONS --- -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <button class="btn b-in" onclick="openHandheldScanModal('attendance')">
                        <i class="fas fa-barcode"></i> تسجيل حضور
                    </button>
                    <button class="btn b-out" onclick="openHandheldScanModal('leave')">
                        <i class="fas fa-barcode"></i> تسجيل انصراف
                    </button>
                </div>

                <div class="toggle-container" style="background:var(--input-bg); border-color:var(--border-color); display:flex; justify-content:space-between; align-items:center; padding:15px; border-radius:12px; margin-bottom:15px;">
                    <div class="toggle-text" style="color:var(--text-color); display:flex; align-items:center; gap:8px; font-weight:700;"><i class="fas fa-stopwatch" style="color:var(--primary);"></i> تثبيت الوقت يدوياً</div>
                    <label class="switch">
                        <input type="checkbox" id="manualTimeToggle" onchange="toggleTimeInput()">
                        <span class="slider" style="position: relative; display: inline-block; width: 54px; height: 30px;"></span>
                        <style>.switch input { opacity: 0; width: 0; height: 0; } .slider { background-color: #cbd5e1; border-radius: 34px; transition: .4s; } .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; } input:checked + .slider { background-color: var(--primary); } input:checked + .slider:before { transform: translateX(24px); }</style>
                    </label>
                </div>

                <div id="manualTimeInputGroup" class="time-sliding-wrapper" style="max-height:0; overflow:hidden; opacity:0; transition:0.4s;">
                    <div class="time-input-box" style="background:var(--card-bg); border:2px dashed var(--border-color); border-radius:10px; padding:10px; display:flex; gap:10px;">
                        <i class="far fa-clock" style="color:var(--primary);"></i>
                        <input type="time" id="manualTimeInput" style="border:none; background:transparent; width:100%; color:var(--text-color); font-weight:600;">
                    </div>
                </div>

                <div class="btn-grid">
                    <button class="btn b-in" onclick="addAttendance()"><i class="fas fa-sign-in-alt"></i> حضور</button>
                    <button class="btn b-out" onclick="addLeave()"><i class="fas fa-sign-out-alt"></i> انصراف</button>
                    <button class="btn b-abs" onclick="markAbsent()"><i class="fas fa-user-slash"></i> غياب</button>
                    <button class="btn b-ded" onclick="showDeductionInput()"><i class="fas fa-file-invoice"></i> خصم</button>
                    <button class="btn b-del no-print" onclick="deleteEmployee()"><i class="fas fa-trash"></i> حذف</button>
                </div>

                <div id="deductionBox" style="display:none; margin-top:15px; animation: fadeIn 0.3s;">
                    <div class="input-group">
                        <label>تفاصيل الخصم</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="deductionInput" class="inp" placeholder="مثال: خصم يوم...">
                            <button class="btn b-ded" onclick="saveDeduction()" style="width:auto; padding:0 20px;"><i class="fas fa-check"></i></button>
                        </div>
                    </div>
                </div>

                <div class="tools no-print">
                    <div class="tools-left">
                        <div class="date-box" style="background:var(--input-bg); padding:8px 15px; border-radius:30px; border:1px solid var(--border-color); display:flex; align-items:center; gap:8px; flex:1; max-width:250px;">
                            <i class="far fa-calendar-alt" style="color:var(--primary)"></i>
                            <input type="date" id="dateFilter" style="border:none; background:transparent; font-size:15px; font-weight:600; color:var(--text-color); width:100%;">
                        </div>
                        
                        <div class="search-box" style="flex:1; max-width:250px; position:relative;">
                            <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--gray); pointer-events:none;"></i>
                            <input type="text" id="tableSearch" class="inp" placeholder="بحث سريع في الجدول..." style="padding-right:40px; padding-left:15px; margin-bottom:0;">
                        </div>
                    </div>

                    <div class="tools-right">
                        <button class="tool-btn no-print" onclick="exportPDF()"><i class="fas fa-file-pdf" style="color:#e74c3c;"></i> PDF</button>
                        <button class="tool-btn no-print" onclick="printReport()"><i class="fas fa-print" style="color:#333;"></i> طباعة</button>
                        <button class="tool-btn no-print" onclick="exportCurrentDayExcel()"><i class="fas fa-file-excel" style="color:#107c41"></i> Excel</button>
                        <button class="tool-btn no-print" onclick="exportWhatsApp()"><i class="fab fa-whatsapp" style="color:#25D366"></i> واتساب</button>
                        <button id="clearAllBtn" class="tool-btn no-print" onclick="confirmClear()"><i class="fas fa-eraser" style="color:var(--danger)"></i> مسح الكل</button>
                    </div>
                </div>
            </div>
            
            <div class="table-wrap" id="printableArea" data-print-date="">
                <div class="t-head">
                    <div class="view-date" id="viewDateDisplay">...</div>
                    <div class="nav-btns">
                        <button class="nav-btn no-print" onclick="changeDate(-1)"><i class="fas fa-chevron-right"></i></button>
                        <button class="nav-btn no-print" onclick="setToday()"><i class="far fa-calendar-check"></i></button>
                        <button class="nav-btn no-print" onclick="changeDate(1)"><i class="fas fa-chevron-left"></i></button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>حضور</th>
                            <th>انصراف</th>
                            <th>الحالة</th>
                            <th>الموقع (GPS)</th>
                            <th>الخصم</th>
                            <th>ملاحظات</th>
                            <th class="no-print">تعديل</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 2: SALARIES -->
        <div id="salaries" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="s-icon c-money"><i class="fas fa-users"></i></div>
                    <div class="s-info"><h4>عدد الموظفين</h4><span id="salaryEmpCount">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="s-icon c-money"><i class="fas fa-wallet"></i></div>
                    <div class="s-info"><h4>صافي المرتبات</h4><span id="netSalaries">0</span> <span id="currencyDisplay"></span></div>
                </div>
            </div>

            <div class="panel">
                <h3 style="margin-bottom:20px; color:var(--primary); font-weight:800;">إدارة بيانات الرواتب</h3>
                
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; align-items:end; position:relative;">
                    <div class="input-group" style="margin-bottom:0; position:relative; z-index:10;">
                        <label>اسم الموظف</label>
                        <input type="text" id="salNameInput" class="inp" placeholder="ابدأ بكتابة الاسم..." onkeyup="suggestNames(this.value)" onblur="setTimeout(()=>hideSuggestions(), 200)">
                        <i class="fas fa-user"></i>
                        <ul id="suggestionList"></ul>
                    </div>

                    <div class="input-group" style="margin-bottom:0;">
                        <label>نوع القبض</label>
                        <select id="salTypeInput" class="inp" style="padding-right:15px; cursor:pointer; background:var(--input-bg); color:var(--text-color);">
                            <option value="monthly">شهري</option>
                            <option value="weekly">أسبوعي</option>
                        </select>
                        <i class="fas fa-calendar-alt"></i>
                    </div>

                    <div class="input-group" style="margin-bottom:0;">
                        <label>المرتب الأساسي</label>
                        <input type="number" id="salAmountInput" class="inp" placeholder="0.00">
                        <i class="fas fa-dollar-sign"></i>
                    </div>

                    <button class="btn b-money" onclick="addSalary()" style="height:48px; margin-bottom:20px;">
                        <i class="fas fa-save"></i> حفظ البيانات
                    </button>
                </div>
            </div>

            <div class="table-wrap">
                <div class="t-head">
                    <div class="view-date">جدول المرتبات والمسحوبات</div>
                    <div class="nav-btns">
                        <button class="nav-btn no-print" onclick="exportSalariesExcel()"><i class="fas fa-file-excel" style="color:#107c41"></i></button>
                        <button class="nav-btn no-print" onclick="exportSalariesWhatsApp()"><i class="fab fa-whatsapp" style="color:#25D366"></i></button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>الموظف</th>
                            <th>المرتب الأساسي</th>
                            <th>نوع القبض</th>
                            <th>المسحوبات (خصم)</th>
                            <th style="color:var(--primary); font-weight:800;">الصافي المستحق</th>
                            <th class="no-print">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="salaryTableBody"></tbody>
                </table>
            </div>
        </div>

        <footer>
            <div class="dev-signature">
                <i class="fas fa-code"></i> تم التطوير بواسطة أحمد شعبان
            </div>
        </footer>
    </div>
    
    <!-- Toast -->
    <div class="toast success" id="toast"><i class="fas fa-check-circle"></i> <span id="toastMsg">تم</span></div>

    <!-- Confirm Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="text-align:center; max-width:350px;">
            <div style="font-size:40px; color:var(--danger); margin-bottom:15px;"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 style="margin-bottom:10px;">تأكيد</h3>
            <p id="confirmMsg" style="color:var(--gray); margin-bottom:20px;">هل أنت متأكد؟</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn b-del" id="confirmCancelBtn" style="flex:1;">إلغاء</button>
                <button class="btn b-in" id="confirmOkBtn" style="flex:1;">نعم</button>
            </div>
        </div>
    </div>

    <!-- HANDHELD SCANNER MODAL -->
    <div class="modal" id="handheldScanModal">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <div class="m-head">
                <div class="m-title" id="scanModalTitle">تسجيل الحضور</div>
                <button class="m-close" onclick="closeModal('handheldScanModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="scan-input-wrapper">
                <p id="scanInstruction" style="margin-bottom: 15px; color: var(--gray); font-size: 14px;">
                    استخدم جهاز المسح اليدوي الآن
                </p>
                <i class="fas fa-barcode" style="font-size: 50px; color: var(--primary); margin-bottom: 15px;"></i>
                <input type="text" id="manualScannerInput" class="scan-input-field" placeholder="في انتظار المسح..." autocomplete="off">
                <p style="font-size: 12px; color: var(--gray);">
                    سيقوم الجهاز بكتابة الرقم والضغط على Enter تلقائياً
                </p>
            </div>
        </div>
    </div>

    <!-- USER MANAGEMENT MODAL (WITH LIVE PREVIEW) -->
    <div class="modal" id="usersModal">
        <div class="modal-content">
            <div class="m-head">
                <div class="m-title">إدارة المستخدمين (المدير فقط)</div>
                <button class="m-close" onclick="closeModal('usersModal')"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="user-creation-layout">
                <!-- Right Side: Inputs -->
                <div class="modal-body">
                    <div class="input-group full">
                        <label>الاسم الكامل</label>
                        <input type="text" id="newUserFullName" class="inp" placeholder="مثال: محمد أحمد" oninput="updateLivePreview()">
                    </div>
                    <div class="input-group full">
                        <label>اسم المستخدم</label>
                        <input type="text" id="newUserName" class="inp" placeholder="للدخول">
                    </div>
                    <div class="edit-grid">
                        <div class="input-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="newUserPass" class="inp" placeholder="********">
                        </div>
                        <div class="input-group">
                            <label>الصلاحية</label>
                            <select id="newUserRole" class="inp" style="padding-right:15px;" onchange="updateLivePreview()">
                                <option value="employee">موظف</option>
                                <option value="hr">مسؤول موارد بشرية</option>
                                <option value="admin">مدير</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group full">
                        <label>صورة الموظف</label>
                        <input type="file" id="newUserPhoto" class="inp" accept="image/*" onchange="handlePhotoUpload(this)" style="padding: 10px;">
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn b-money full" onclick="addNewUser()" style="margin-top:10px;">
                            <i class="fas fa-save"></i> إضافة مستخدم
                        </button>
                        <button class="btn b-in full" onclick="printLiveCard()" style="margin-top:10px; background: var(--success);">
                            <i class="fas fa-print"></i> طباعة البطاقة
                        </button>
                    </div>

                    <div class="users-list" id="usersListContainer" style="margin-top: 20px;">
                        <!-- Users will appear here -->
                    </div>
                </div>

                <!-- Left Side: Live ID Card Preview -->
                <div style="border-right: 1px solid var(--border-color); padding-right: 20px; position: sticky; top: 0;">
                    <h4 style="text-align:center; margin-bottom:15px; color:var(--gray);">معاينة البطاقة</h4>
                    <div id="idCardPreview" class="id-card-wrapper">
                        <div class="id-card-header">
                            <h2 id="previewCompanyName">اسم الشركة</h2>
                        </div>
                        <div class="id-card-photo">
                            <img id="previewImage" src="https://via.placeholder.com/150" alt="Photo">
                        </div>
                        <div class="id-card-info">
                            <div class="id-card-name" id="previewName">اسم الموظف</div>
                            <div class="id-card-role" id="previewRole">موظف</div>
                        </div>
                        <div class="id-card-footer">
                            <svg id="previewBarcode"></svg>
                            <div style="font-size: 16px; font-weight: bold; letter-spacing: 2px;" id="previewPin">---- ----</div>
                        </div>
                    </div>
                    <p style="font-size:12px; color:var(--gray); text-align:center; margin-top:10px;">
                        تأكد من أن البيانات صحيحة قبل الطباعة
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- SYSTEM SETTINGS MODAL -->
    <div class="modal" id="sysSettingsModal">
        <div class="modal-content">
            <div class="m-head">
                <div class="m-title">إعدادات النظام المتقدمة (المدير فقط)</div>
                <button class="m-close" onclick="closeModal('sysSettingsModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:15px; color:var(--gray); font-size:13px;">قم بتخصيص النظام وسياسات العمل.</p>
                
                <div class="edit-grid">
                    <div class="input-group">
                        <label>اسم الشركة</label>
                        <input type="text" id="sysCompanyName" class="inp">
                    </div>
                    <div class="input-group">
                        <label>عملة الرواتب</label>
                        <input type="text" id="sysCurrency" class="inp">
                    </div>
                </div>

                <div class="edit-grid">
                    <div class="input-group">
                        <label>وقت بداية الدوام</label>
                        <input type="time" id="sysStartTime" class="inp">
                    </div>
                    <div class="input-group">
                        <label>فترة السماح (دقائق)</label>
                        <input type="number" id="sysGracePeriod" class="inp" placeholder="مثال: 15">
                    </div>
                </div>

                <div class="edit-grid">
                    <div class="input-group">
                        <label>معدل الساعة الإضافية</label>
                        <input type="number" id="sysOvertimeRate" class="inp" placeholder="0.00">
                    </div>
                    <div class="input-group">
                        <label>قيمة الخصم عن التأخير</label>
                        <input type="number" id="sysLateDeduction" class="inp" placeholder="0.00">
                    </div>
                </div>

                <div class="input-group full">
                    <label>رابط شعار الشركة (URL)</label>
                    <input type="url" id="sysLogoUrl" class="inp" placeholder="https://example.com/logo.png">
                </div>

                <div class="input-group full">
                    <label>خروج تلقائي بعد (دقائق)</label>
                    <select id="sysAutoLogout" class="inp" style="padding-right:15px;">
                        <option value="0">معطل</option>
                        <option value="5">5 دقائق</option>
                        <option value="15">15 دقيقة</option>
                        <option value="30">30 دقيقة</option>
                        <option value="60">ساعة واحدة</option>
                    </select>
                </div>

                <button class="btn b-money full" onclick="saveSystemSettings()" style="margin-top:10px;">حفظ الإعدادات</button>
            </div>
        </div>
    </div>

    <!-- ACTIVITY LOG MODAL -->
    <div class="modal" id="activityLogModal">
        <div class="modal-content">
            <div class="m-head">
                <div class="m-title">سجل النشاطات (المدير فقط)</div>
                <button class="m-close" onclick="closeModal('activityLogModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="activityTimeline" class="activity-timeline">
                    <!-- Logs go here -->
                </div>
            </div>
        </div>
    </div>

    <!-- CHANGE PASSWORD MODAL -->
    <div class="modal" id="changePassModal">
        <div class="modal-content">
            <div class="m-head">
                <div class="m-title">تغيير كلمة المرور</div>
                <button class="m-close" onclick="closeModal('changePassModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="input-group full">
                    <label>كلمة المرور الحالية</label>
                    <input type="password" id="currPassChange" class="inp">
                </div>
                <div class="input-group full">
                    <label>كلمة المرور الجديدة</label>
                    <input type="password" id="newPassChange" class="inp">
                </div>
                <button class="btn b-money full" onclick="saveMyNewPassword()" style="margin-top:10px;">تحديث</button>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL (Attendance) -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="m-head">
                <div class="m-title">تعديل السجل</div>
                <button class="m-close" onclick="closeModal('editModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editDate">
                <div class="input-group full">
                    <label>اسم الموظف</label>
                    <input type="text" id="editName" class="inp">
                </div>
                <div class="edit-grid">
                    <div class="input-group">
                        <label>وقت الحضور</label>
                        <input type="time" id="editIn" class="inp">
                    </div>
                    <div class="input-group">
                        <label>وقت الانصراف</label>
                        <input type="time" id="editOut" class="inp">
                    </div>
                </div>
                <div class="input-group" style="margin-top:15px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="editAbsent"> تسجيل كغائب (يلغي الأوقات)
                    </label>
                </div>
                <div class="input-group">
                    <label>الخصم</label>
                    <input type="text" id="editDeduction" class="inp" placeholder="تفاصيل الخصم...">
                </div>
                <div class="input-group full">
                    <label>ملاحظات إضافية</label>
                    <textarea id="editNotes" class="inp" placeholder="اكتب أي ملاحظات هنا..."></textarea>
                </div>
                <button class="btn b-in full" onclick="saveEdit()" style="margin-top:10px;">حفظ التعديلات</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARS ---
        let db = JSON.parse(localStorage.getItem("attnDB")) || {};
        let salaryDB = JSON.parse(localStorage.getItem("salaryDB")) || [];
        let currentUser = null; 
        
        // --- Scan Action Var (Holds 'attendance' or 'leave') ---
        let currentScanAction = 'attendance'; 
        let tempPhotoBase64 = "https://via.placeholder.com/150";
        let tempPin = "";

        // --- INIT USERS ---
        function initUsers() {
            if(!localStorage.getItem("usersDB")) {
                const defaultAdmin = {
                    id: Date.now(),
                    fullName: "أحمد شعبان",
                    username: "ahmedshaban",
                    password: "01099431484",
                    role: "admin",
                    pin: Math.floor(1000 + Math.random() * 9000).toString(),
                    photo: "https://via.placeholder.com/150"
                };
                localStorage.setItem("usersDB", JSON.stringify([defaultAdmin]));
            } else {
                let users = JSON.parse(localStorage.getItem("usersDB"));
                let updated = false;
                users.forEach(u => {
                    if(!u.pin) {
                        u.pin = Math.floor(1000 + Math.random() * 9000).toString();
                        updated = true;
                    }
                    if(!u.photo) u.photo = "https://via.placeholder.com/150";
                });
                if(updated) localStorage.setItem("usersDB", JSON.stringify(users));
            }
        }
        initUsers();

        // --- SYSTEM SETTINGS INIT ---
        function initSystemSettings() {
            if(!localStorage.getItem("sysSettings")) {
                const defaults = {
                    companyName: "نظام الإدارة المتكامل",
                    currency: "ج.م",
                    workStart: "09:00",
                    gracePeriod: 0,
                    overtimeRate: 0,
                    lateDeduction: 0,
                    logoUrl: "",
                    autoLogout: 0
                };
                localStorage.setItem("sysSettings", JSON.stringify(defaults));
            }
            applySystemSettings();
        }
        initSystemSettings();

        // --- AUTH LOGIC ---
        function getUsers() { return JSON.parse(localStorage.getItem("usersDB")); }

        function attemptLogin() {
            const userIn = document.getElementById('authUser').value.trim();
            const passIn = document.getElementById('authPass').value.trim();
            const users = getUsers();
            const user = users.find(u => u.username === userIn && u.password === passIn);

            if(user) {
                localStorage.setItem("currentUser", JSON.stringify(user));
                document.getElementById('auth-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.querySelector('.container').style.display = 'block';
                    loadUserSession();
                }, 400);
                playSound('success');
                logActivity('login', `قام المستخدم ${user.fullName} بتسجيل الدخول`);
            } else {
                document.getElementById('loginError').style.opacity = '1';
                document.getElementById('loginCard').classList.add('shake');
                setTimeout(() => document.getElementById('loginCard').classList.remove('shake'), 500);
                playSound('error');
            }
        }

        function logout() {
            if(confirm("هل أنت متأكد من تسجيل الخروج؟")) {
                localStorage.removeItem("currentUser");
                location.reload();
            }
        }

        document.getElementById('authPass').addEventListener("keypress", function(e) {
            if (e.key === "Enter") attemptLogin();
        });

        // --- SOUND EFFECTS ---
        function playSound(type) {
            const audio = new Audio();
            if (type === 'success') {
                audio.src = "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3";
            } else if (type === 'error') {
                audio.src = "https://assets.mixkit.co/active_storage/sfx/2576/2576-preview.mp3";
            }
            audio.volume = 0.3;
            audio.play().catch(e => console.log('Audio play failed', e));
        }

        // --- ACTIVITY LOG ---
        function logActivity(action, details) {
            let logs = JSON.parse(localStorage.getItem("activityLog")) || [];
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if(!currentUser) return;
            logs.unshift({
                user: currentUser.fullName,
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            });
            if(logs.length > 50) logs = logs.slice(0, 50);
            localStorage.setItem("activityLog", JSON.stringify(logs));
        }

        function openActivityLog() {
            if(currentUser.role !== 'admin') { return showToast('عذراً، هذه الصلاحية للمدير فقط'); }
            const logs = JSON.parse(localStorage.getItem("activityLog")) || [];
            const container = document.getElementById('activityTimeline');
            container.innerHTML = '';
            if(logs.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--gray);">لا توجد نشاطات مسجلة</p>';
            }
            logs.forEach(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleTimeString('ar-EG') + ' - ' + date.toLocaleDateString('ar-EG');
                let icon = 'info-circle';
                if(log.action === 'login') icon = 'sign-in-alt';
                if(log.action === 'sys_change') icon = 'cogs';
                if(log.action === 'add_user') icon = 'user-plus';
                if(log.action === 'delete') icon = 'trash';
                const item = document.createElement('div');
                item.className = 'log-item';
                item.innerHTML = `
                    <div class="log-time"><i class="far fa-clock"></i> ${timeStr}</div>
                    <div class="log-text"><i class="fas fa-${icon}"></i> ${log.action === 'login' ? 'تسجيل دخول' : (log.action === 'sys_change' ? 'تغيير إعدادات' : (log.action === 'add_user' ? 'إضافة مستخدم' : 'عملية عامة'))}</div>
                    <div class="log-detail">${log.details}</div>
                `;
                container.appendChild(item);
            });
            document.getElementById('activityLogModal').style.display = 'flex';
        }

        // --- PDF EXPORT ---
        function exportPDF() {
            const element = document.getElementById('printableArea');
            const dateStr = document.getElementById('viewDateDisplay').innerText;
            const originalBorder = element.style.border;
            element.style.border = "1px solid #ccc";
            const opt = {
                margin: 0.5, filename: `Report_${dateStr}.pdf`, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                element.style.border = originalBorder; showToast('تم تحميل التقرير بصيغة PDF'); playSound('success');
            });
        }

        // --- AUTO LOGOUT LOGIC ---
        let inactivityTimer = null;
        function initInactivityTimer() {
            const settings = JSON.parse(localStorage.getItem("sysSettings"));
            const limitMinutes = settings ? parseInt(settings.autoLogout) : 0;
            
            if(limitMinutes > 0) {
                let seconds = 0;
                const limitSeconds = limitMinutes * 60;
                
                window.onmousemove = resetTimer;
                window.onkeypress = resetTimer;
                window.ontouchstart = resetTimer;
                window.onscroll = resetTimer;

                function resetTimer() { seconds = 0; }

                inactivityTimer = setInterval(() => {
                    seconds++;
                    if(seconds >= limitSeconds) {
                        clearInterval(inactivityTimer);
                        showToast('تم الخروج التلقائي بسبب عدم النشاط');
                        logout();
                    }
                }, 1000);
            } else if (inactivityTimer) {
                clearInterval(inactivityTimer);
                window.onmousemove = null;
                window.onkeypress = null;
            }
        }

        // --- SESSION & PERMISSIONS ---
        function loadUserSession() {
            currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if(!currentUser) return;
            document.getElementById('userInfoDisplay').innerHTML = `<i class="fas fa-user-circle"></i> ${currentUser.fullName}`;
            applyPermissions(currentUser.role);
            updateClock(); setInterval(updateClock, 1000);
            refresh(); updateStats(); applyTheme(); initInactivityTimer();
            
            document.getElementById('tableSearch').addEventListener('input', handleSearch);
        }

        function applyPermissions(role) {
            const tools = document.querySelector('.tools'); const salariesTab = document.getElementById('salariesTabBtn');
            const adminBtn = document.getElementById('adminUsersBtn'); const sysBtn = document.getElementById('sysSettingsBtn');
            const logBtn = document.getElementById('activityLogBtn'); const clearBtn = document.getElementById('clearAllBtn');
            const navBtns = document.querySelector('.nav-btns'); const nameInput = document.getElementById('employeeName');

            if (role !== 'admin') {
                if(adminBtn) adminBtn.style.display = 'none';
                if(sysBtn) sysBtn.style.display = 'none';
                if(logBtn) logBtn.style.display = 'none';
                if(clearBtn) clearBtn.style.display = 'none';
            }
            if (role === 'employee') {
                if(tools) tools.style.display = 'none';
                if(salariesTab) salariesTab.style.display = 'none';
                setToday(); document.getElementById('dateFilter').disabled = true;
                if(navBtns) navBtns.style.display = 'none';
                nameInput.value = currentUser.fullName; nameInput.readOnly = true;
            } else if (role === 'hr') {
                document.getElementById('dateFilter').disabled = false; nameInput.readOnly = false; nameInput.value = "";
            } else if (role === 'admin') {
                document.getElementById('dateFilter').disabled = false; nameInput.readOnly = false;
            }
        }

        // --- SYSTEM SETTINGS LOGIC ---
        function openSystemSettings() {
            if(currentUser.role !== 'admin') { return showToast('عذراً، هذه الصلاحية للمدير فقط'); }
            const settings = JSON.parse(localStorage.getItem("sysSettings"));
            document.getElementById('sysCompanyName').value = settings.companyName;
            document.getElementById('sysCurrency').value = settings.currency;
            document.getElementById('sysStartTime').value = settings.workStart;
            document.getElementById('sysGracePeriod').value = settings.gracePeriod;
            document.getElementById('sysOvertimeRate').value = settings.overtimeRate;
            document.getElementById('sysLateDeduction').value = settings.lateDeduction;
            document.getElementById('sysLogoUrl').value = settings.logoUrl;
            document.getElementById('sysAutoLogout').value = settings.autoLogout;
            document.getElementById('sysSettingsModal').style.display = 'flex';
        }

        function saveSystemSettings() {
            if(currentUser.role !== 'admin') return;
            const newSettings = {
                companyName: document.getElementById('sysCompanyName').value,
                currency: document.getElementById('sysCurrency').value,
                workStart: document.getElementById('sysStartTime').value,
                gracePeriod: document.getElementById('sysGracePeriod').value,
                overtimeRate: document.getElementById('sysOvertimeRate').value,
                lateDeduction: document.getElementById('sysLateDeduction').value,
                logoUrl: document.getElementById('sysLogoUrl').value,
                autoLogout: document.getElementById('sysAutoLogout').value
            };
            localStorage.setItem("sysSettings", JSON.stringify(newSettings));
            applySystemSettings();
            initInactivityTimer(); 
            closeModal('sysSettingsModal');
            showToast('تم حفظ إعدادات النظام');
            playSound('success');
            logActivity('sys_change', `تم تغيير إعدادات النظام`);
        }

        function applySystemSettings() {
            const settings = JSON.parse(localStorage.getItem("sysSettings"));
            if(settings) {
                document.getElementById('companyNameDisplay').innerText = settings.companyName;
                document.getElementById('previewCompanyName').innerText = settings.companyName;
                document.title = settings.companyName;
                document.getElementById('currencyDisplay').innerText = settings.currency;
                
                const logoContainer = document.getElementById('headerLogo');
                if(settings.logoUrl && settings.logoUrl.trim() !== "") {
                    logoContainer.innerHTML = `<img src="${settings.logoUrl}" alt="Logo">`;
                    logoContainer.style.background = "transparent";
                    logoContainer.style.boxShadow = "none";
                } else {
                    logoContainer.innerHTML = `<i class="fas fa-building"></i>`;
                    logoContainer.style.background = "var(--primary)";
                    logoContainer.style.boxShadow = "0 4px 15px rgba(67, 97, 238, 0.4)";
                }
            }
        }

        // --- USER MANAGEMENT (WITH PHOTO & PREVIEW) ---
        function openUsersModal() {
            if(currentUser.role !== 'admin') { return showToast('عذراً، هذه الصلاحية للمدير فقط'); }
            renderUsersList();
            // Generate a temporary PIN for preview
            tempPin = Math.floor(1000 + Math.random() * 9000).toString();
            updateLivePreview();
            document.getElementById('usersModal').style.display = 'flex';
        }

        function renderUsersList() {
            const list = document.getElementById('usersListContainer');
            const users = getUsers(); list.innerHTML = '';
            users.forEach(u => {
                const item = document.createElement('div'); item.className = 'user-item';
                let roleLabel = u.role === 'admin' ? 'مدير' : (u.role === 'hr' ? 'HR' : 'موظف');
                let delBtn = '';
                if(u.id !== currentUser.id) {
                    delBtn = `<button class="action-btn del" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>`;
                }
                
                item.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px; flex:1;">
                        <img src="${u.photo}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid #eee;">
                        <div style="font-weight:bold; font-size:15px;">${u.fullName}</div>
                        <div class="user-role-badge" style="margin-right:auto;">${roleLabel}</div>
                        <div class="user-pin-box">
                            <span>رقم الباركود:</span> 
                            <span style="background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">${u.pin}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <button class="action-btn del" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                    </div>`;
                list.appendChild(item);
            });
        }

        // Handle Photo Upload
        function handlePhotoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempPhotoBase64 = e.target.result;
                    document.getElementById('previewImage').src = tempPhotoBase64;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Update Live Preview
        function updateLivePreview() {
            const name = document.getElementById('newUserFullName').value || "اسم الموظف";
            const role = document.getElementById('newUserRole');
            const roleText = role.options[role.selectedIndex].text;
            
            document.getElementById('previewName').innerText = name;
            document.getElementById('previewRole').innerText = roleText;
            document.getElementById('previewPin').innerText = tempPin;

            // Generate Barcode dynamically
            try {
                JsBarcode("#previewBarcode", tempPin, {
                    format: "CODE128",
                    lineColor: "#000",
                    width: 1.5,
                    height: 60,
                    displayValue: false,
                    margin: 5
                });
            } catch(e) { console.log("Barcode waiting for data"); }
        }

        function addNewUser() {
            const name = document.getElementById('newUserFullName').value.trim();
            const user = document.getElementById('newUserName').value.trim();
            const pass = document.getElementById('newUserPass').value.trim();
            const role = document.getElementById('newUserRole').value;
            if(!name || !user || !pass) return showToast('برجاء ملء جميع البيانات');
            const users = getUsers();
            if(users.find(u => u.username === user)) return showToast('اسم المستخدم موجود بالفعل');
            
            users.push({ 
                id: Date.now(), 
                fullName: name, 
                username: user, 
                password: pass, 
                role: role,
                pin: tempPin,
                photo: tempPhotoBase64 
            });
            localStorage.setItem("usersDB", JSON.stringify(users));
            
            // Reset form
            document.getElementById('newUserFullName').value = ''; 
            document.getElementById('newUserName').value = ''; 
            document.getElementById('newUserPass').value = '';
            document.getElementById('newUserPhoto').value = "";
            tempPhotoBase64 = "https://via.placeholder.com/150";
            tempPin = Math.floor(1000 + Math.random() * 9000).toString();
            
            renderUsersList(); 
            updateLivePreview();
            showToast('تمت إضافة المستخدم'); 
            playSound('success'); 
            logActivity('add_user', `تم إضافة مستخدم جديد: ${name}`);
        }

        function deleteUser(id) {
            showConfirm('هل أنت متأكد من حذف هذا المستخدم؟', () => {
                let users = getUsers(); const userToDelete = users.find(u => u.id === id);
                users = users.filter(u => u.id !== id);
                localStorage.setItem("usersDB", JSON.stringify(users));
                renderUsersList(); showToast('تم الحذف'); playSound('success'); logActivity('delete', `تم حذف المستخدم: ${userToDelete.fullName}`);
            });
        }

        // Print Live Card Function
        function printLiveCard() {
            // Add class to body to trigger print CSS
            document.body.classList.add('printing-mode');
            window.print();
            // Remove class after printing
            setTimeout(() => document.body.classList.remove('printing-mode'), 1000);
        }

        // --- CHANGE PASSWORD ---
        function openChangePassModal() { document.getElementById('changePassModal').style.display = 'flex'; }
        function saveMyNewPassword() {
            const curr = document.getElementById('currPassChange').value;
            const newP = document.getElementById('newPassChange').value;
            if(curr !== currentUser.password) return showToast('كلمة المرور الحالية خاطئة');
            if(!newP) return showToast('أدخل كلمة مرور جديدة');
            let users = getUsers(); let idx = users.findIndex(u => u.id === currentUser.id);
            users[idx].password = newP; localStorage.setItem("usersDB", JSON.stringify(users));
            currentUser.password = newP; localStorage.setItem("currentUser", JSON.stringify(currentUser));
            closeModal('changePassModal'); showToast('تم تغيير كلمة المرور بنجاح'); playSound('success');
        }

        // --- GLOBAL DATA ---
        const dateIn = document.getElementById('dateFilter');
        dateIn.valueAsDate = new Date();

        // --- THEME & UTILS ---
        function updateClock() { document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString('en-US', {hour12: true}); }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        function applyTheme() {
            if(localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }
        }
        function showToast(msg, type='success') {
            const t = document.getElementById('toast'); 
            document.getElementById('toastMsg').innerText = msg;
            t.className = `toast show ${type}`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'attendance') { refresh(); updateStats(); } else { renderSalaries(); updateSalaryStats(); }
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- ATTENDANCE LOGIC ---
        function fmtDate(d) { return d.getDate().toString().padStart(2,'0') + "/" + (d.getMonth()+1).toString().padStart(2,'0') + "/" + d.getFullYear(); }
        function toKey(val) { if(!val) return ""; let [y,m,d] = val.split('-'); return d+"/"+m+"/"+y; }
        function fmtTime(d) { let h=d.getHours(), m=d.getMinutes().toString().padStart(2,'0'); return (h%12||12)+":"+m+(h>=12?"م":"ص"); }
        function toTimeInput(str) { 
            if(!str) return ""; let cleanStr = str.replace(/[^0-9:]/g, ''); let parts = cleanStr.split(':');
            if(parts.length < 2) return ""; let h = parseInt(parts[0]); let m = parts[1] || "00";
            if (isNaN(h)) return ""; let isPM = str.includes('م'); if (isPM && h !== 12) h += 12; else if (!isPM && h === 12) h = 0; 
            return h.toString().padStart(2, '0') + ":" + m.padStart(2, '0'); 
        }
        function manualFmt(str) { if(!str) return ""; let[h,m]=str.split(':'); h=parseInt(h); return (h%12||12)+":"+m+(h>=12?"م":"ص"); }
        function getRowId(name) { return "row-" + name.replace(/\s+/g, '-').replace(/[^\w\-]/g, ''); }
        function getT() { return document.getElementById('manualTimeToggle').checked ? manualFmt(document.getElementById('manualTimeInput').value) : fmtTime(new Date()); }
        function save() { localStorage.setItem("attnDB", JSON.stringify(db)); refresh(); updateStats(); }

        function refresh() {
            const key = toKey(dateIn.value);
            document.getElementById('viewDateDisplay').innerText = key;
            let data = db[key] || [];
            if(currentUser && currentUser.role === 'employee') { data = data.filter(e => e.name === currentUser.fullName); }
            const tb = document.getElementById('tableBody'); tb.innerHTML = "";
            if(!data.length) { tb.innerHTML = `<tr><td colspan="8" style="padding:30px; color:#aaa; text-align:center;">لا توجد سجلات</td></tr>`; return; }
            data.forEach(e => {
                let badge = e.absent ? `<span class="badge bg-abs">غائب</span>` : (e.attendance && e.leave ? `<span class="badge bg-lev">مغادر</span>` : (e.attendance ? `<span class="badge bg-pres">حاضر</span>` : '-'));
                let notes = e.notes || '-'; let ded = e.deduction || '-';
                let locHtml = e.location ? `<a href="https://www.google.com/maps?q=${e.location}" target="_blank" title="عرض الموقع"><i class="fas fa-map-marker-alt" style="color:var(--primary);"></i> <small>تم التسجيل</small></a>` : '-';
                
                const tr = document.createElement('tr');
                tr.id = getRowId(e.name);
                tr.innerHTML = `<td style="font-weight:bold">${e.name}</td><td style="color:var(--success)">${e.attendance||'-'}</td><td style="color:var(--danger)">${e.leave||'-'}</td><td>${badge}</td><td>${locHtml}</td><td style="font-size:12px; color:#e67e22">${ded}</td><td style="font-size:12px; color:var(--text-color); max-width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${notes}</td><td class="no-print"><button class="action-btn" onclick="openEdit('${key}','${e.name}')"><i class="fas fa-pen"></i></button><button class="action-btn del" onclick="delRec('${key}','${e.name}')"><i class="fas fa-trash"></i></button></td>`;
                tb.appendChild(tr);
            });
        }

        function getEmp(day, name) { if(!db[day]) db[day]=[]; let e=db[day].find(x=>x.name==name); if(!e){e={name}; db[day].push(e);} return e; }

        function addAttendance(userObj = null) {
            let n = userObj ? userObj.fullName : document.getElementById('employeeName').value.trim(); 
            if(!n) return showToast('أدخل الاسم');
            let k = fmtDate(new Date()); let e = getEmp(k,n);
            if(e.attendance) return showToast('مسجل مسبقاً'); 
            
            getGeoLocation((loc) => {
                e.location = loc;
                e.attendance=getT(); e.absent=""; save(); 
                if(userObj) {
                    showToast(`مرحباً بك، ${n}`);
                } else {
                    showToast('تم الحضور');
                }
                playSound('success'); 
                logActivity('attendance', `تسجيل حضور للموظف: ${n}`);
            });
        }
        
        function addLeave(userObj = null) {
            let n = userObj ? userObj.fullName : document.getElementById('employeeName').value.trim(); 
            if(!n) return showToast('أدخل الاسم');
            let k = fmtDate(new Date()); let e = getEmp(k,n);
            if(!e.attendance) return showToast('لم يحضر بعد'); 
            if(e.leave) return showToast('سجل انصراف'); 
            e.leave=getT(); save(); 
            
            if(userObj) {
                showToast(`مع السلامة، ${n}`);
            } else {
                showToast('تم الانصراف');
            }
            playSound('success'); 
            logActivity('leave', `تسجيل انصراف للموظف: ${n}`);
        }

        function markAbsent() {
            let n = document.getElementById('employeeName').value.trim(); if(!n) return showToast('أدخل الاسم');
            let k = fmtDate(new Date()); let e = getEmp(k,n);
            e.absent="غائب"; e.attendance=""; e.leave=""; save(); showToast('تم الغياب'); playSound('success'); logActivity('absence', `تسجيل غياب للموظف: ${n}`);
        }
        function showDeductionInput() {
            let n = document.getElementById('employeeName').value.trim(); if(!n) return showToast('أدخل الاسم');
            let b = document.getElementById('deductionBox'); b.style.display = b.style.display=='block'?'none':'block'; if(b.style.display=='block') document.getElementById('deductionInput').focus();
        }
        function saveDeduction() {
            let n = document.getElementById('employeeName').value.trim(); let txt = document.getElementById('deductionInput').value.trim();
            if(!txt) return showToast('اكتب التفاصيل');
            let e = getEmp(fmtDate(new Date()), n); e.deduction=txt; document.getElementById('deductionInput').value=""; document.getElementById('deductionBox').style.display='none'; save(); showToast('تم تسجيل الخصم'); playSound('success');
        }
        function deleteEmployee() {
            let n = document.getElementById('employeeName').value.trim(); if(!n) return showToast('أدخل الاسم');
            showConfirm('سيتم حذف سجل اليوم للموظف: ' + n, () => {
                let k = fmtDate(new Date()); 
                if(db[k]) { db[k]=db[k].filter(x=>x.name!=n); save(); showToast('تم الحذف'); playSound('success'); logActivity('delete_attendance', `حذف سجل حضور: ${n}`); }
            });
        }
        function toggleTimeInput() {
            const isChecked = document.getElementById('manualTimeToggle').checked;
            const wrapper = document.getElementById('manualTimeInputGroup');
            wrapper.style.maxHeight = isChecked ? '80px' : '0'; wrapper.style.opacity = isChecked ? '1' : '0';
        }
        function changeDate(d) { let cur = new Date(dateIn.value); cur.setDate(cur.getDate()+d); dateIn.valueAsDate = cur; refresh(); }
        function setToday() { dateIn.valueAsDate = new Date(); refresh(); }
        function confirmClear() { 
            showConfirm('سيتم مسح جميع البيانات من النظام. هل أنت متأكد؟', () => { 
                db={}; localStorage.setItem("attnDB", JSON.stringify(db)); save(); showToast('تم المسح'); playSound('success'); logActivity('clear_all', 'تم مسح جميع بيانات الحضور');
            }); 
        }
        function updateStats() {
            let k = fmtDate(new Date()); let p=0, a=0, l=0;
            let data = db[k] || [];
            if(currentUser && currentUser.role === 'employee') {
                data = data.filter(x => x.name === currentUser.fullName);
            }
            data.forEach(e => { if(e.absent)a++; else if(e.attendance&&e.leave)l++; else if(e.attendance)p++; });
            document.getElementById('presentCount').innerText=p; document.getElementById('absentCount').innerText=a; document.getElementById('leaveCount').innerText=l;
        }

        // --- EDIT LOGIC ---
        function openEdit(day, name) {
            if(!db[day]) return;
            let rec = db[day].find(x => x.name === name);
            if(!rec) return;
            
            document.getElementById('editDate').value = day;
            document.getElementById('editName').value = rec.name;
            document.getElementById('editIn').value = toTimeInput(rec.attendance || '');
            document.getElementById('editOut').value = toTimeInput(rec.leave || '');
            document.getElementById('editAbsent').checked = !!rec.absent;
            document.getElementById('editDeduction').value = rec.deduction || '';
            document.getElementById('editNotes').value = rec.notes || '';
            document.getElementById('editModal').style.display = 'flex';
        }

        function saveEdit() {
            let day = document.getElementById('editDate').value;
            let name = document.getElementById('editName').value;
            let idx = db[day].findIndex(x => x.name === name);
            if(idx > -1) {
                db[day][idx].attendance = manualFmt(document.getElementById('editIn').value);
                db[day][idx].leave = manualFmt(document.getElementById('editOut').value);
                db[day][idx].absent = document.getElementById('editAbsent').checked ? "غائب" : "";
                if(db[day][idx].absent) { db[day][idx].attendance = ""; db[day][idx].leave = ""; }
                db[day][idx].deduction = document.getElementById('editDeduction').value;
                db[day][idx].notes = document.getElementById('editNotes').value;
                save(); closeModal('editModal'); showToast('تم الحفظ'); logActivity('edit_attendance', `تعديل سجل: ${name}`);
            }
        }

        function delRec(day, name) { 
            showConfirm('حذف؟', () => { 
                db[day]=db[day].filter(x=>x.name!=name); 
                save(); 
                showToast('تم الحذف'); 
                playSound('success'); 
            }); 
        }

        function handleSearch(e) {
            const val = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(val) ? '' : 'none';
            });
        }

        function exportCurrentDayExcel() {
            const key = toKey(document.getElementById('dateFilter').value);
            const data = db[key] || [];
            if (data.length === 0) return showToast('لا توجد بيانات في هذا اليوم للتصدير', 'error');
            const ws_data = [
                ["تقرير الحضور والانصراف"],
                ["التاريخ:", key],
                [],
                ["الاسم", "وقت الحضور", "وقت الانصراف", "الحالة", "الموقع", "الخصم", "ملاحظات"]
            ];
            data.forEach(row => {
                let status = row.absent ? 'غائب' : (row.attendance && row.leave ? 'مغادر' : (row.attendance ? 'حاضر' : ''));
                ws_data.push([row.name, row.attendance || '-', row.leave || '-', status, row.location || '-', row.deduction || '-', row.notes || '-']);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [{wch:20}, {wch:15}, {wch:15}, {wch:10}, {wch:25}, {wch:15}, {wch:20}];
            XLSX.utils.book_append_sheet(wb, ws, "الحضور");
            XLSX.writeFile(wb, `Attendance_${key}.xlsx`);
            showToast('تم تصدير ملف Excel بنجاح');
            playSound('success');
        }

        // --- SALARIES LOGIC ---
        function addSalary() {
            const name = document.getElementById('salNameInput').value.trim();
            const type = document.getElementById('salTypeInput').value; 
            const amount = parseFloat(document.getElementById('salAmountInput').value);
            if (!name || isNaN(amount)) return showToast('برجاء إدخال الاسم والمبلغ بشكل صحيح');
            let index = salaryDB.findIndex(s => s.name === name);
            const isUpdate = index > -1;
            const entry = { id: isUpdate ? salaryDB[index].id : Date.now(), name: name, type: type, salary: amount, deductions: isUpdate ? salaryDB[index].deductions : [] };
            if(isUpdate) { salaryDB[index] = entry; showToast('تم التحديث'); logActivity('edit_salary', `تحديث مرتب: ${name}`); } 
            else { salaryDB.push(entry); showToast('تم الإضافة'); logActivity('add_salary', `إضافة مرتب جديد: ${name}`); }
            localStorage.setItem("salaryDB", JSON.stringify(salaryDB));
            document.getElementById('salNameInput').value = ''; document.getElementById('salAmountInput').value = '';
            renderSalaries(); updateSalaryStats(); playSound('success');
        }
        function renderSalaries() {
            const tbody = document.getElementById('salaryTableBody'); tbody.innerHTML = '';
            const currency = document.getElementById('currencyDisplay').innerText || "ج.م";
            salaryDB.forEach((s, index) => {
                const totalDed = s.deductions.reduce((sum, d) => sum + d.amount, 0);
                const netSalary = s.salary - totalDed;
                const typeLabel = s.type === 'weekly' ? 'أسبوعي' : 'شهري';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${index + 1}</td><td style="font-weight:bold; color:var(--primary);">${s.name}</td><td style="font-family:monospace; font-size:16px;">${s.salary.toLocaleString()} ${currency}</td><td><span class="badge" style="background:var(--input-bg); color:var(--text-color);">${typeLabel}</span></td><td style="color:var(--danger); font-weight:bold;">-${totalDed.toLocaleString()} ${currency}</td><td style="color:var(--success); font-weight:bold; font-size:16px;">${netSalary.toLocaleString()} ${currency}</td><td class="no-print"><button class="action-btn del" onclick="deleteSalary(${s.id})"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        function deleteSalary(id) { showConfirm('حذف هذا الموظف؟', () => { salaryDB = salaryDB.filter(s => s.id !== id); localStorage.setItem("salaryDB", JSON.stringify(salaryDB)); renderSalaries(); updateSalaryStats(); showToast('تم الحذف'); playSound('success'); }); }
        function updateSalaryStats() { document.getElementById('salaryEmpCount').innerText = salaryDB.length; let t = 0; salaryDB.forEach(s => { t += (s.salary - s.deductions.reduce((a,b)=>a+b.amount,0)); }); document.getElementById('netSalaries').innerText = t.toLocaleString(); }
        function suggestNames(q) { /* Simplified */ } function hideSuggestions() { document.getElementById('suggestionList').style.display = 'none'; }
        function printReport() { window.print(); }
        function exportWhatsApp() { showToast('تم إرسال البيانات للنسخ'); } 
        
        // Confirm Dialog Logic
        let confirmCallback = null;
        function showConfirm(msg, cb) {
            document.getElementById('confirmMsg').innerText = msg; confirmCallback = cb; document.getElementById('confirmModal').style.display = 'flex';
        }
        document.getElementById('confirmCancelBtn').onclick = () => { closeModal('confirmModal'); confirmCallback=null; };
        document.getElementById('confirmOkBtn').onclick = () => { if(confirmCallback) confirmCallback(); closeModal('confirmModal'); confirmCallback=null; };

        // --- BARCODE SCANNER LOGIC (HANDHELD) ---
        function openHandheldScanModal(action) {
            currentScanAction = action;
            const title = action === 'attendance' ? "تسجيل الحضور" : "تسجيل الانصراف";
            const instruction = action === 'attendance' ? "مرر البطاقة أمام الماسح" : "مرر البطاقة أمام الماسح";
            document.getElementById('scanModalTitle').innerText = title;
            document.getElementById('scanInstruction').innerText = instruction;
            document.getElementById('manualScannerInput').value = "";
            document.getElementById('handheldScanModal').style.display = 'flex';
            setTimeout(() => document.getElementById('manualScannerInput').focus(), 100);
        }

        document.getElementById('manualScannerInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const scannedCode = this.value.trim();
                if (!scannedCode) { showToast('لم يتم قراءة الرقم', 'error'); return; }
                const user = getUsers().find(u => u.pin === scannedCode);
                if (user) {
                    playSound('success');
                    closeModal('handheldScanModal');
                    if(currentScanAction === 'attendance') { addAttendance(user); } 
                    else if (currentScanAction === 'leave') { addLeave(user); }
                } else {
                    playSound('error');
                    showToast('رقم غير مسجل', 'error');
                    this.value = "";
                }
            }
        });

        function getGeoLocation(callback) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const loc = `${position.coords.latitude},${position.coords.longitude}`;
                    callback(loc);
                }, (error) => { console.warn("Geo location error:", error); callback(null); });
            } else { callback(null); }
        }

        // Initialize if logged in
        if(localStorage.getItem("currentUser")) loadUserSession();
    </script>
</body>
</html>
